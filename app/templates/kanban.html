{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/" class="text-decoration-none text-muted"><i class="bi bi-arrow-left"></i> ZurÃ¼ck zum Kalender</a>
            <h2 class="display-6 mt-2">{{ project.title }}</h2>
            <p class="text-muted">{{ project.description }}</p>
        </div>

        <div>
            <span class="badge bg-secondary me-2">Projekt ID: {{ project.id }}</span>

            <form action="/projects/{{ project.id }}/delete" method="post" class="d-inline" onsubmit="return confirm('Projekt wirklich unwiderruflich lÃ¶schen? Alle Tasks werden entfernt!');">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="bi bi-trash"></i> Projekt lÃ¶schen
                </button>
            </form>
        </div>
    </div>

    <div class="row h-100">
        <div class="col-md-4">
            <div class="card bg-light h-100 shadow-sm">
                <div class="card-header bg-danger text-white fw-bold d-flex justify-content-between align-items-center">
                    <span>To Do ðŸ“Œ</span>
                    <button class="btn btn-sm btn-light text-danger py-0" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-lg"></i> Neu
                    </button>
                </div>
                <div class="card-body kanban-column" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in todo %}
                        {% include "partials/task_card.html" %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light h-100 shadow-sm">
                <div class="card-header bg-warning text-dark fw-bold">In Arbeit ðŸš§</div>
                <div class="card-body kanban-column" id="in_progress" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in progress %}
                        {% include "partials/task_card.html" %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-light h-100 shadow-sm">
                <div class="card-header bg-success text-white fw-bold">Fertig âœ…</div>
                <div class="card-body kanban-column" id="done" ondrop="drop(event)" ondragover="allowDrop(event)">
                    {% for task in done %}
                        {% include "partials/task_card.html" %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Neuen Task hinzufÃ¼gen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form action="/projects/{{ project.id }}/tasks/create" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Titel</label>
                        <input type="text" name="title" class="form-control" placeholder="z.B. GetrÃ¤nke kaufen" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">PrioritÃ¤t</label>
                        <select name="priority" class="form-select">
                            <option value="Easy">Easy ðŸŸ¢</option>
                            <option value="Medium" selected>Medium ðŸŸ¡</option>
                            <option value="Urgent">Urgent ðŸ”´</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Beschreibung (Optional)</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="submit" class="btn btn-danger">HinzufÃ¼gen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Task bearbeiten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form id="editTaskForm" action="" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Titel</label>
                        <input type="text" name="title" id="editTaskTitle" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">PrioritÃ¤t</label>
                        <select name="priority" id="editTaskPriority" class="form-select">
                            <option value="Easy">Easy ðŸŸ¢</option>
                            <option value="Medium">Medium ðŸŸ¡</option>
                            <option value="Urgent">Urgent ðŸ”´</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Beschreibung</label>
                        <textarea name="description" id="editTaskDesc" class="form-control" rows="4"></textarea>
                    </div>
                </div>

                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> LÃ¶schen
                    </button>

                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </div>
                </div>
            </form>

            <form id="deleteTaskForm" action="" method="post" style="display:none;"></form>
        </div>
    </div>
</div>

<style>
    .kanban-column {
        min-height: 500px;
        transition: background-color 0.2s;
    }
    .kanban-column.drag-over {
        background-color: #e9ecef;
        border: 2px dashed #adb5bd;
    }
    .task-card {
        cursor: grab;
        transition: transform 0.1s;
    }
    .task-card:active {
        cursor: grabbing;
        transform: rotate(2deg);
    }
</style>

<script>
    // === 1. Drag & Drop Logik ===

    function allowDrop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }

    function drag(ev) {
        // Speichert die ID des gezogenen Elements
        ev.dataTransfer.setData("text", ev.currentTarget.id);
    }

    function drop(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');

        var data = ev.dataTransfer.getData("text");
        var taskCard = document.getElementById(data);

        // Ziel finden (auch wenn man auf eine andere Karte droppt)
        var targetColumn = ev.target.closest('.kanban-column');

        if (targetColumn) {
            targetColumn.appendChild(taskCard);

            var newStatus = targetColumn.id;
            var taskId = data.replace("task-", "");

            saveMove(taskId, newStatus);
        }
    }

    // Drag-Over Effekt entfernen beim Verlassen
    document.querySelectorAll('.kanban-column').forEach(col => {
        col.addEventListener('dragleave', (e) => {
            e.currentTarget.classList.remove('drag-over');
        });
    });

    function saveMove(taskId, newStatus) {
        var formData = new FormData();
        formData.append('status', newStatus);

        fetch(`/tasks/${taskId}/move`, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                console.log("Status gespeichert: " + newStatus);
            } else {
                alert("Fehler beim Speichern!");
            }
        });
    }

    // === 2. Edit & Delete Logik (NEU mit data-attributes) ===

    function openEditFromButton(btnElement) {
        // Daten aus den HTML-Attributen lesen
        var id = btnElement.getAttribute('data-id');
        var title = btnElement.getAttribute('data-title');
        var desc = btnElement.getAttribute('data-desc');
        var priority = btnElement.getAttribute('data-priority');

        // Modal Felder fÃ¼llen
        document.getElementById('editTaskTitle').value = title;
        document.getElementById('editTaskDesc').value = desc;
        document.getElementById('editTaskPriority').value = priority; // Dropdown setzen

        // Formular URLs setzen
        document.getElementById('editTaskForm').action = "/tasks/" + id + "/update";
        document.getElementById('deleteTaskForm').action = "/tasks/" + id + "/delete";

        // Modal anzeigen
        var myModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
        myModal.show();
    }

    function confirmDelete() {
        if(confirm("MÃ¶chtest du diesen Task wirklich unwiderruflich lÃ¶schen?")) {
            document.getElementById('deleteTaskForm').submit();
        }
    }
</script>
{% endblock %}